{% extends "item_base.html" %}{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block rel_canonical %}{% endblock %}

{% block item_content %}
{% load blog_tags %}
{% if feed_url %}<a style="float: right; border-bottom: none; margin-top: 0.4em" href="{{ feed_url }}" title="Atom feed"><svg
    xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 256 256"
    role="img" aria-labelledby="atomFeedTitle">
 <title id="atomFeedTitle">Atom feed</title>
 <defs>
   <linearGradient id="a" x1=".1" x2=".9" y1=".1" y2=".9">
     <stop offset="0" stop-color="#E3702D"></stop>
     <stop offset=".1" stop-color="#EA7D31"></stop>
     <stop offset=".4" stop-color="#F69537"></stop>
     <stop offset=".5" stop-color="#FB9E3A"></stop>
     <stop offset=".7" stop-color="#EA7C31"></stop>
     <stop offset=".9" stop-color="#DE642B"></stop>
     <stop offset="1" stop-color="#D95B29"></stop>
   </linearGradient>
 </defs>
 <rect width="256" height="256" fill="#CC5D15" rx="55" ry="55"></rect>
 <rect width="246" height="246" x="5" y="5" fill="#F49C52" rx="50" ry="50"></rect>
 <rect width="236" height="236" x="10" y="10" fill="url(#a)" rx="47" ry="47"></rect>
 <circle cx="68" cy="189" r="24" fill="#FFF"></circle>
 <path fill="#FFF" d="M160 213h-34a82 82 0 0 0-82-82V97a116 116 0 0 1 116 116z"></path>
 <path fill="#FFF" d="M184 213A140 140 0 0 0 44 73V38a175 175 0 0 1 175 175z"></path>
</svg>
</a>{% endif %}
<h2>{{ title }}</h2>

<form action="{% if fixed_type %}/search/{% else %}{{ request.path }}{% endif %}" method="GET">
    <input type="search" class="search-input" name="q" value="{{ q }}" style="width: 80%" autocomplete="off">
    <input type="submit" class="search-submit" value="Search">
    {% if selected %}
        {% for pair in selected.items %}
            {% if pair.0 == 'tags' %}
                {% for tag in pair.1 %}
                    <input type="hidden" name="tag" value="{{ tag }}">
                {% endfor %}
            {% else %}
                <input type="hidden" name="{{ pair.0 }}" value="{{ pair.1 }}">
            {% endif %}
        {% endfor %}
    {% endif %}
    {% for param, value in id_filter_params.items %}
        <input type="hidden" name="{{ param }}" value="{{ value }}">
    {% endfor %}
</form>

{% if id_filter_type_names %}
<p class="id-filter-notice">
    Filtered to specific {{ id_filter_type_names|join:", " }}
    <a href="{% remove_id_filters %}" title="Clear filter">&#x00D7;</a>
</p>
{% endif %}

<p class="search-selections">
    {% if selected %}<span class="filters">
        Filters:
        {% if selected.type and not fixed_type %}
            <a class="selected-tag" href="{% remove_qsarg "type" selected.type %}">Type: {{ selected.type }} <strong>&#x00D7;</strong></a>
        {% endif %}
        {% if selected.year %}
            <a class="selected-tag" href="{% remove_qsarg "year" selected.year %}">Year: {{ selected.year }} <strong>&#x00D7;</strong></a>
        {% endif %}
        {% if selected.month %}
            <a class="selected-tag" href="{% remove_qsarg "month" selected.month %}">Month: {{ selected.month_name }} <strong>&#x00D7;</strong></a>
        {% endif %}
        {% if selected.beat %}
            <a class="selected-tag" href="{% remove_qsarg "beat" selected.beat %}">Beat: {{ selected.beat_label }} <strong>&#x00D7;</strong></a>
        {% endif %}
        {% for tag in selected.tags %}
            <a class="selected-tag" href="{% remove_qsarg "tag" tag %}">{{ tag }} <strong>&#x00D7;</strong></a>
        {% endfor %}
    </span>{% endif %}
    {% if results %}
        Sorted by <strong>{{ sort }}</strong>{% if q %} &middot; {% endif %}
        {% if sort == "date" and q %}<a href="{% replace_qsarg "sort" "relevance" %}">relevance</a>{% endif %}
        {% if sort == "relevance" %}<a href="{% replace_qsarg "sort" "date" %}">date</a>{% endif %}
    {% endif %}
</p>

<div id="autocomplete-tags" aria-live="polite"></div>

{% if total %}
    {% if selected or q or id_filters %}
        {% include "_pagination.html" with page_total=total %}
        {% blog_mixed_list_with_dates results %}
        {% include "_pagination.html" %}
    {% endif %}
{% else %}
    {% if selected or q or id_filters %}
        <p><strong>No results found</strong></p>
        {% if suggestion and num_corrected_results %}
            <p style="margin: 1em 0">Suggestion: <a href="/search/?q={{ suggestion }}">{{ suggestion }}</a> ({{ num_corrected_results }} result{{ num_corrected_results|pluralize }})</p>
        {% endif %}
    {% endif %}
{% endif %}

{% endblock %}

{% block secondary %}
<div class="metabox">
    {% if type_counts and not fixed_type %}
        <h3 id="facet-types">Types</h3>
        <ul>
            {% for t in type_counts %}
                <li{% if t.type == "beat" %} class="beat-facet" style="display:none"{% endif %}><a href="{% add_qsarg "type" t.type %}">{{ t.type }}</a> {{ t.n|intcomma }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if beat_type_counts %}
        <div class="beat-facet" style="display:none">
        <h3 id="facet-beat-types">Beats</h3>
        <ul>
            {% for t in beat_type_counts %}
                <li><a href="{% add_qsarg "beat" t.beat_type %}">{{ t.label }}</a> {{ t.n|intcomma }}</a></li>
            {% endfor %}
        </ul>
        </div>
    {% endif %}
    {% if year_counts %}
        <h3 id="facet-years">Years</h3>
        <ul>
            {% for t in year_counts %}
                <li><a href="{% add_qsarg "year" t.year|date:"Y" %}">{{ t.year|date:"Y" }}</a> {{ t.n|intcomma }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if month_counts %}
        <h3 id="facet-months">Months</h3>
        <ul>
            {% for t in month_counts %}
                <li><a href="{% add_qsarg "month" t.month|date:"n" %}">{{ t.month|date:"F" }}</a> {{ t.n|intcomma }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if tag_counts %}
        <h3 id="facet-tags">Tags</h3>
        <ul>
            {% for t in tag_counts %}
                <li><a href="{% add_qsarg "tag" t.tag %}">{{ t.tag }}</a> {{ t.n|intcomma }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}
</div>
<script>
if (localStorage.getItem('show_beats')) {
  document.querySelectorAll('.beat-facet').forEach(function(el) { el.style.display = ''; });
}
</script>
<script>
function debounce(func, wait) {
  let timeout;
  return function (...args) {
    const context = this;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

function fetchTags(query) {
  fetch(`/tags-autocomplete/?q=${query}`)
    .then((response) => response.json())
    .then((data) => {
      const tagsContainer = document.getElementById("autocomplete-tags");
      tagsContainer.innerHTML = "";
      if (data.tags.length > 0) {
        const p = document.createElement("p");
        p.appendChild(document.createTextNode("Tags "));
        data.tags.forEach((tag) => {
          const a = document.createElement("a");
          a.href = `/tags/${tag.tag}/`;
          a.className = "item-tag";
          a.innerHTML = `${tag.tag} <span>${tag.count}</span>`;
          p.appendChild(a);
          // Add a space between tags
          p.appendChild(document.createTextNode(" "));
        });
        tagsContainer.appendChild(p);
      }
    });
}
const searchInput = document.querySelector(".search-input");
searchInput.addEventListener(
  "input",
  debounce(function () {
    const query = this.value.trim();
    if (query.length > 0) {
      fetchTags(query);
    } else {
      document.getElementById("autocomplete-tags").innerHTML = "";
    }
  }, 500),
);
if (searchInput.value) {
  fetchTags(searchInput.value);
}
</script>
{% endblock %}
